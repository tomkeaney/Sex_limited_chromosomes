---
title: "Extinction analysis"
author: "Thomas Keaney, Heidi Wong, Xiameng Qi, Theresa Jones and Luke Holman"
#bibliography: "supp_references.bib"
output:
  html_document:
    code_folding: hide
    depth: 1
    number_sections: no
    theme: yeti
    toc: yes
    toc_float: yes
    code_download: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
```

# Setup for analysis

## Load packages

```{r}
library(Matrix) # sometimes needed for tidyverse to load successfully
library(tidyverse) # tidy style coding
library(brms) # Bayesian models
library(loo) # to use information criteria in brms models
library(tidybayes) # Bayesian aesthetics
library(MetBrewer) # colours
library(kableExtra) # tables
library(patchwork) # putting plots together
library(DT) # for search- and saveable tables
library(pander) # for simpler tables
library(ggdark)

```

## Load in the data 

$~$

```{r}

extinction_data <- 
  read_csv("data/Extinction_data.csv") 


extinction_data_b1 <-
  extinction_data %>%
  # here we create a censoring column. If the family a) escaped or was killed by something unrelated to the experiment or b) survived the 20 generations of the experiment, then we code a value of 1. If the family went extinct, we code a value of 0. This allows us to right censor the data, thereby preserving the information it provides on extinction.
  mutate(across(Gen_1:Gen_11, ~replace_na(.x, "Escape")),
         censored_alive = if_else(Gen_11 == "YES", 1, 0),
         censored_escape = if_else(Gen_11 == "Escape", 1, 0),
         censored = censored_alive + censored_escape) %>% 
  filter(Block           == "1") %>% # FOR NOW WE ONLY RUN ANALYSIS ON THE FIRST BLOCK 
  mutate(Cross           = as.factor(Population),
         Treatment       = as.factor(Treatment),
         Family          = as.factor(Family),
         Block           = as.factor(Block),
         Gen_1           = if_else(Gen_1 == "YES", 1, 0),
         Gen_2           = if_else(Gen_2 == "YES", 1, 0),
         Gen_3           = if_else(Gen_3 == "YES", 1, 0),
         Gen_4           = if_else(Gen_4 == "YES", 1, 0),
         Gen_5           = if_else(Gen_5 == "YES", 1, 0),
         Gen_6           = if_else(Gen_6 == "YES", 1, 0),
         Gen_7           = if_else(Gen_7 == "YES", 1, 0),
         Gen_8           = if_else(Gen_8 == "YES", 1, 0),
         Gen_9           = if_else(Gen_9 == "YES", 1, 0),
         Gen_10          = if_else(Gen_10 == "YES", 1, 0),
         Gen_11          = if_else(Gen_11 == "YES", 1, 0),
         Gen_12          = if_else(Gen_12 == "YES", 1, 0),
         Gen_13          = if_else(Gen_13 == "YES", 1, 0),
         Gen_14           = if_else(Gen_14 == "YES", 1, 0),
         Gen_15           = if_else(Gen_15 == "YES", 1, 0),
         Gen_16           = if_else(Gen_16 == "YES", 1, 0),
         Gen_17          = if_else(Gen_17 == "YES", 1, 0),
         Gen_18          = if_else(Gen_18 == "YES", 1, 0),
         Gen_19          = if_else(Gen_19 == "YES", 1, 0),
         Gen_20          = if_else(Gen_20 == "YES", 1, 0),
         gens_to_extinct = Gen_1 + Gen_2 + Gen_3 + Gen_4 + 
           Gen_5 + Gen_6 + Gen_7 + Gen_8 + Gen_9 + Gen_10 + 
           Gen_11 + Gen_12 + Gen_13 + Gen_14 + Gen_15 + Gen_16 + 
           Gen_17 + Gen_18 + Gen_19 + Gen_20 + 1) %>% 
  select(-Population) %>% 
  select(Family, Cross, Treatment, Block, everything())
         
# Model everything up to Gen 11

extinction_data_all <-
  extinction_data %>% 
  select(1:15) %>% 
   mutate(across(Gen_1:Gen_11, ~replace_na(.x, "Escape")),
         censored_alive = if_else(Gen_11 == "YES", 1, 0),
         censored_escape = if_else(Gen_11 == "Escape", 1, 0),
         censored = censored_alive + censored_escape,
         Cross           = as.factor(Population),
         Treatment       = as.factor(Treatment),
         Family          = as.factor(Family),
         Block           = as.factor(Block),
         Gen_1           = if_else(Gen_1 == "YES", 1, 0),
         Gen_2           = if_else(Gen_2 == "YES", 1, 0),
         Gen_3           = if_else(Gen_3 == "YES", 1, 0),
         Gen_4           = if_else(Gen_4 == "YES", 1, 0),
         Gen_5           = if_else(Gen_5 == "YES", 1, 0),
         Gen_6           = if_else(Gen_6 == "YES", 1, 0),
         Gen_7           = if_else(Gen_7 == "YES", 1, 0),
         Gen_8           = if_else(Gen_8 == "YES", 1, 0),
         Gen_9           = if_else(Gen_9 == "YES", 1, 0),
         Gen_10          = if_else(Gen_10 == "YES", 1, 0),
         Gen_11          = if_else(Gen_11 == "YES", 1, 0),
         gens_to_extinct = Gen_1 + Gen_2 + Gen_3 + Gen_4 + 
           Gen_5 + Gen_6 + Gen_7 + Gen_8 + Gen_9 + Gen_10 + 
           Gen_11 + 1) %>% 
  select(-Population) %>% 
  select(Family, Cross, Treatment, Block, everything())


         

#extinction_data <-
 # rbind(extinction_data_b1, extinction_data_b2)


# Create a function to build HTML searchable tables

my_data_table <- function(df){
  datatable(
    df, rownames=FALSE,
    autoHideNavigation = TRUE,
    extensions = c("Scroller",  "Buttons"),
    options = list(
      dom = 'Bfrtip',
      deferRender=TRUE,
      scrollX=TRUE, scrollY=400,
      scrollCollapse=TRUE,
      buttons =
        list('pageLength', 'colvis', 'csv', list(
          extend = 'pdf',
          pageSize = 'A4',
          orientation = 'landscape',
          filename = 'extinction_data')),
      pageLength = 500
    )
  )
}


my_data_table(extinction_data_b1)

```

**Column explanations**

Cross: we measured extinction and productivity of families derived from 36 different population crosses. Crosses were only conducted between populations that experienced the same evolution treatment. **Note that crosses are repeated in both directions, how should we handle this data?**

Family: the specific family of flies that we tracked the lineage of. We generated the next generation of each family via a single full-sibling dyad.

Block: the experiment was run in 2 distinct blocks, using flies from separate generations.

Evolution_treatment: the populations had been exposed to one of three evolutionary conditions for 20 generations: a female-limited response to selection, a male-limited response and a control condition where the evolutionary response was unconstrained.

Gen_1:20: a 1 indicates the family was extant for the generation in question, while a 0 indicates extinction.

gens_to_extinct: the number of generations the family survived until they went extinct

censored: a 1 indicates that the family was not removed from the dataset by extinction.

$~$

## Fit an exponential model

$~$

```{r}
extinction_model_b1 <-
  brm(data = extinction_data_b1, #%>% filter(Block == 1),
      family = exponential,
      gens_to_extinct | cens(censored) ~ 0 + Treatment + (1|Cross),
      prior(normal(0, 1), class = b),
      iter = 8000, warmup = 4000, chains = 4, cores = 4,
      seed = 11, control = list(adapt_delta = .9),
      file = "Fits/extinction_model_exponential_b1")

extinction_model <-
  brm(data = extinction_data_all,
      family = exponential,
      gens_to_extinct | cens(censored) ~ 0 + Treatment + Block + (1|Cross),
      prior(normal(0, 1), class = b),
      iter = 8000, warmup = 4000, chains = 4, cores = 4,
      seed = 11, control = list(adapt_delta = .9),
      file = "Fits/extinction_model_exponential")

print(extinction_model)

```

`brms` fits survival models so that the mean of the exponential distribution is the inverse of the rate. We want to know the rate of decay (or extinction in our case), \lambda, so we must use the equation

$\lambda= 1 / exp(\mu)$

e.g. 

```{r}
1 / exp(fixef(extinction_model_b1)[, -2])


1 / exp(fixef(extinction_model)[, -2])

```

This is the rate of extinction per generation. We find that families carrying control chromosomes have the fastest rate of extinction, followed by families carrying feminised chromosomes. Families carrying masculinised chromosomes appear the most resilient against extinction!

Visualising the data will give us a better idea of what is specifically occurring.

$~$

## Build exponential model figures

$~$

```{r}
# wrangle
model_estimates <-
  fixef(extinction_model_b1) %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  mutate(Evolution_treatment = str_remove(rowname, "Treatment")) %>% 
  # most important step. We predict over 20 generations, assuming a constant rate of decline 
  expand(nesting(Estimate, Q2.5, Q97.5, Evolution_treatment), 
         generations = 0:20) %>% 
  mutate(m  = 1 - pexp(generations, rate = 1 / exp(Estimate)),
         ll = 1 - pexp(generations, rate = 1 / exp(Q2.5)),
         ul = 1 - pexp(generations, rate = 1 / exp(Q97.5)))
  
# plot!
exponential_surv_plot <-
  model_estimates %>% 
  ggplot(aes(x = generations)) +
  #geom_hline(yintercept = .5, linetype = 3) +
  geom_ribbon(aes(ymin = ll, ymax = ul, fill = Evolution_treatment),
              alpha = 1/2) +
  geom_line(aes(y = m, color = Evolution_treatment), linetype =5) +
  scale_fill_manual(values = met.brewer("Hiroshige", 3)) +
  scale_color_manual(values = met.brewer("Hiroshige", 3)) +
  scale_y_continuous("Proportion of surving families", breaks = c(0, .5, 1), limits = 0:1) +
  xlab("Generations") +
  labs(title = "Exponential model") +
  theme_bw() + 
  theme(panel.grid.minor = element_blank())
```

Another way to explore this model is to ask: About how many generations would it take for half of the populations of a given evolutionary history to go extinct? We can do this with help from the `qexp()` function. For example:

```{r}
# wrangle
extinction_draws <-
  as_draws_df(extinction_model_b1) %>% 
  pivot_longer(starts_with("b_")) %>% 
  mutate(Evolution_treatment = str_remove(name, "b_Treatment"),
         generations  = qexp(p = .5, rate = 1 / exp(value))) %>% 
  select(Evolution_treatment, generations)

# axis breaks
medians <-
  group_by(extinction_draws, Evolution_treatment) %>% 
  summarise(med = median(generations)) %>% 
  pull(med) %>% 
  round(., digits = 1)

# plot!

ext_p1 <-
  extinction_draws %>% 
  ggplot(aes(x = generations, y = Evolution_treatment)) +
  stat_halfeye(aes(fill = Evolution_treatment), .width = .95, height = 1, alpha = 1) +
  scale_fill_manual(values = met.brewer("Hiroshige", 5)) +
  ylab("Evolution treatment") +
  xlab("Generations untill 50% of families\nare extinct") +
  #coord_cartesian(ylim = c(1.5, 5.1)) +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor = element_blank())

# Now plot the contrasts

extinction_draws_contrasts <-
  as_draws_df(extinction_model_b1) %>%
  mutate(b_TreatmentControl = qexp(p = .5, rate = 1 / exp(b_TreatmentControl)),
         b_TreatmentFemale = qexp(p = .5, rate = 1 / exp(b_TreatmentFemale)),
         b_TreatmentMale = qexp(p = .5, rate = 1 / exp(b_TreatmentMale))) %>% 
  mutate(`Female - control` = b_TreatmentFemale - b_TreatmentControl,
         `Male - control` = b_TreatmentMale - b_TreatmentControl,
         `Male - Female` = b_TreatmentMale - b_TreatmentFemale) %>% 
  pivot_longer(cols = `Female - control`:`Male - Female`)

ext_p2 <-
  extinction_draws_contrasts %>% 
  ggplot(aes(x = value, y = name)) +
  stat_halfeye(aes(fill = name), .width = .95, height = 1, alpha = 1) +
  geom_vline(xintercept = 0, linetype = 2, colour = "black") +
  scale_fill_manual(values = met.brewer("Hiroshige", 5)) +
  ylab("Treatment contrast") +
  xlab("Difference between treatments until\n50% of families are extinct (generations)") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor = element_blank())

ext_p1 + ext_p2
```

$~$

## Is our model any good?

$~$

We first conduct a posterior predictive check. Put simply, we use the posterior distribution to estimate the data on which it was trained. If it recapitulates the shape of the original data, we have specified a reasonable distribution to estimate the data generating process.

```{r}
pp_check(extinction_model, type = "hist", ndraws = 11, binwidth = 1) +
  theme_minimal() +
  theme(panel.background = element_blank())
```

The panel in the top left shows the raw data, while the remaining 11 panels show draws from our model. The x-axis shows generations and the y-axis extinction events. Our data clearly isn't perfectly exponential, but it is pretty close.

While we can be reasonably happy with this model fit, there are more flexible distribution families that might improve estimation accuracy. These families don't assume a constant rate of decay like the exponential family does. Next we try one of these: the weibull distribution.

$~$

## Fitting a weibull model

$~$

```{r}
extinction_model_weibull_b1 <-
  brm(data = extinction_data_b1,
      family = weibull, init = 0,
      gens_to_extinct | cens(censored) ~ 0 + Treatment + (1|Cross),
      prior(normal(0, 1), class = b), # depending on defaults for all other priors
      iter = 8000, warmup = 4000, chains = 4, cores = 4,
      seed = 11, control = list(adapt_delta = .9, max_treedepth = 10),
      file = "Fits/extinction_model_weibull_b1")

extinction_model_weibull <-
  brm(data = extinction_data_all,
      family = weibull, init = 0,
      gens_to_extinct | cens(censored) ~ 0 + Treatment + Block + (1|Cross),
      prior(normal(0, 1), class = b), # depending on defaults for all other priors
      iter = 8000, warmup = 4000, chains = 4, cores = 4,
      seed = 11, control = list(adapt_delta = .9, max_treedepth = 10),
      file = "Fits/extinction_model_weibull")

print(extinction_model_weibull)

```

Lets see how this model recapitulates the data

```{r}
pp_check(extinction_model_weibull, type = "hist", ndraws = 11, binwidth = 1) +
  theme_minimal() +
  theme(panel.background = element_blank())
```

We can also compare the LOO score for both models. 

```{r}
extinction_model <- add_criterion(extinction_model, criterion = "loo")
extinction_model_weibull <- add_criterion(extinction_model_weibull, criterion = "loo")

# compare

loo_compare(extinction_model, extinction_model_weibull, criterion = "loo")
```

The weibull model has a lower deviance score, suggesting it may be better for prediction.

$~$

## Plotting the weibull data

$~$

As with the exponential model we can find the rate of extinction using the same equation:

**Can we though? What about the shape parameter?**

```{r}
1 / exp(fixef(extinction_model_weibull_b1)[, -2])

1 / exp(fixef(extinction_model_weibull)[, -2])
```

This is the rate of extinction per generation. However, the weibull family allows a dynamic rate rather the the constant rate that the exponential constrains it to.

The weibull transformation can be done like this:

$\lambda= exp(\mu) / \gamma(1 + \frac{1}{k})$

where $k$ is the shape parameter estimated in `brms`

Then we can find survival at time t using

$S = exp(-(t/\lambda)^k)$

We plug in a vector with 4000 draws from the posterior distribution for 1) \mu of each inheritance treatment and 2) the shape parameter

```{r}
# Find lambda for the three treatments. 

lambda_distribution_b1 <-
  as_draws_df(extinction_model_weibull_b1) %>% 
  mutate(Control_lambda = exp(b_TreatmentControl) / gamma(1 + 1/shape),
         Female_lambda = exp(b_TreatmentFemale) / gamma(1 + 1/shape),
         Male_lambda = exp(b_TreatmentMale) / gamma(1 + 1/shape)) %>% 
  select(Control_lambda, Female_lambda, Male_lambda, shape)

lambda_distribution <-
  as_draws_df(extinction_model_weibull) %>% 
  mutate(Control_lambda = exp(b_TreatmentControl) / gamma(1 + 1/shape),
         Female_lambda = exp(b_TreatmentFemale) / gamma(1 + 1/shape),
         Male_lambda = exp(b_TreatmentMale) / gamma(1 + 1/shape)) %>% 
  select(Control_lambda, Female_lambda, Male_lambda, shape)

# Now find survival proportion at generations 1-20

Weibull_extinction_estimates_b1 <- 
  lambda_distribution_b1 %>% 
  mutate(Control_0  = exp(-(0/Control_lambda)^shape),
         Control_1  = exp(-(1/Control_lambda)^shape),
         Control_2  = exp(-(2/Control_lambda)^shape),
         Control_3  = exp(-(3/Control_lambda)^shape),
         Control_4  = exp(-(4/Control_lambda)^shape),
         Control_5  = exp(-(5/Control_lambda)^shape),
         Control_6  = exp(-(6/Control_lambda)^shape),
         Control_7  = exp(-(7/Control_lambda)^shape),
         Control_8  = exp(-(8/Control_lambda)^shape),
         Control_9  = exp(-(9/Control_lambda)^shape),
         Control_10 = exp(-(10/Control_lambda)^shape),
         Control_11 = exp(-(11/Control_lambda)^shape),
         Control_12 = exp(-(12/Control_lambda)^shape),
         Control_13 = exp(-(13/Control_lambda)^shape),
         Control_14 = exp(-(14/Control_lambda)^shape),
         Control_15 = exp(-(15/Control_lambda)^shape),
         Control_16 = exp(-(16/Control_lambda)^shape),
         Control_17 = exp(-(17/Control_lambda)^shape),
         Control_18 = exp(-(18/Control_lambda)^shape),
         Control_19 = exp(-(19/Control_lambda)^shape),
         Control_20 = exp(-(20/Control_lambda)^shape),
         Female_0   = exp(-(0/Female_lambda)^shape),
         Female_1   = exp(-(1/Female_lambda)^shape),
         Female_2   = exp(-(2/Female_lambda)^shape),
         Female_3   = exp(-(3/Female_lambda)^shape),
         Female_4   = exp(-(4/Female_lambda)^shape),
         Female_5   = exp(-(5/Female_lambda)^shape),
         Female_6   = exp(-(6/Female_lambda)^shape),
         Female_7   = exp(-(7/Female_lambda)^shape),
         Female_8   = exp(-(8/Female_lambda)^shape),
         Female_9   = exp(-(9/Female_lambda)^shape),
         Female_10  = exp(-(10/Female_lambda)^shape),
         Female_11  = exp(-(11/Female_lambda)^shape),
         Female_12  = exp(-(12/Female_lambda)^shape),
         Female_13  = exp(-(13/Female_lambda)^shape),
         Female_14  = exp(-(14/Female_lambda)^shape),
         Female_15  = exp(-(15/Female_lambda)^shape),
         Female_16  = exp(-(16/Female_lambda)^shape),
         Female_17  = exp(-(17/Female_lambda)^shape),
         Female_18  = exp(-(18/Female_lambda)^shape),
         Female_19  = exp(-(19/Female_lambda)^shape),
         Female_20  = exp(-(20/Female_lambda)^shape),
         Male_0     = exp(-(0/Male_lambda)^shape),
         Male_1     = exp(-(1/Male_lambda)^shape),
         Male_2     = exp(-(2/Male_lambda)^shape),
         Male_3     = exp(-(3/Male_lambda)^shape),
         Male_4     = exp(-(4/Male_lambda)^shape),
         Male_5     = exp(-(5/Male_lambda)^shape),
         Male_6     = exp(-(6/Male_lambda)^shape),
         Male_7     = exp(-(7/Male_lambda)^shape),
         Male_8     = exp(-(8/Male_lambda)^shape),
         Male_9     = exp(-(9/Male_lambda)^shape),
         Male_10    = exp(-(10/Male_lambda)^shape),
         Male_11    = exp(-(11/Male_lambda)^shape),
         Male_12    = exp(-(12/Male_lambda)^shape),
         Male_13    = exp(-(13/Male_lambda)^shape),
         Male_14    = exp(-(14/Male_lambda)^shape),
         Male_15    = exp(-(15/Male_lambda)^shape),
         Male_16    = exp(-(16/Male_lambda)^shape),
         Male_17    = exp(-(17/Male_lambda)^shape),
         Male_18    = exp(-(18/Male_lambda)^shape),
         Male_19    = exp(-(19/Male_lambda)^shape),
         Male_20    = exp(-(20/Male_lambda)^shape)) %>% 
    select(-c(Control_lambda, Female_lambda, Male_lambda, shape))

Weibull_extinction_estimates <- 
  lambda_distribution %>% 
  mutate(Control_0  = exp(-(0/Control_lambda)^shape),
         Control_1  = exp(-(1/Control_lambda)^shape),
         Control_2  = exp(-(2/Control_lambda)^shape),
         Control_3  = exp(-(3/Control_lambda)^shape),
         Control_4  = exp(-(4/Control_lambda)^shape),
         Control_5  = exp(-(5/Control_lambda)^shape),
         Control_6  = exp(-(6/Control_lambda)^shape),
         Control_7  = exp(-(7/Control_lambda)^shape),
         Control_8  = exp(-(8/Control_lambda)^shape),
         Control_9  = exp(-(9/Control_lambda)^shape),
         Control_10 = exp(-(10/Control_lambda)^shape),
         Control_11 = exp(-(11/Control_lambda)^shape),
         Control_12 = exp(-(12/Control_lambda)^shape),
         Control_13 = exp(-(13/Control_lambda)^shape),
         Control_14 = exp(-(14/Control_lambda)^shape),
         Control_15 = exp(-(15/Control_lambda)^shape),
         Control_16 = exp(-(16/Control_lambda)^shape),
         Control_17 = exp(-(17/Control_lambda)^shape),
         Control_18 = exp(-(18/Control_lambda)^shape),
         Control_19 = exp(-(19/Control_lambda)^shape),
         Control_20 = exp(-(20/Control_lambda)^shape),
         Female_0   = exp(-(0/Female_lambda)^shape),
         Female_1   = exp(-(1/Female_lambda)^shape),
         Female_2   = exp(-(2/Female_lambda)^shape),
         Female_3   = exp(-(3/Female_lambda)^shape),
         Female_4   = exp(-(4/Female_lambda)^shape),
         Female_5   = exp(-(5/Female_lambda)^shape),
         Female_6   = exp(-(6/Female_lambda)^shape),
         Female_7   = exp(-(7/Female_lambda)^shape),
         Female_8   = exp(-(8/Female_lambda)^shape),
         Female_9   = exp(-(9/Female_lambda)^shape),
         Female_10  = exp(-(10/Female_lambda)^shape),
         Female_11  = exp(-(11/Female_lambda)^shape),
         Female_12  = exp(-(12/Female_lambda)^shape),
         Female_13  = exp(-(13/Female_lambda)^shape),
         Female_14  = exp(-(14/Female_lambda)^shape),
         Female_15  = exp(-(15/Female_lambda)^shape),
         Female_16  = exp(-(16/Female_lambda)^shape),
         Female_17  = exp(-(17/Female_lambda)^shape),
         Female_18  = exp(-(18/Female_lambda)^shape),
         Female_19  = exp(-(19/Female_lambda)^shape),
         Female_20  = exp(-(20/Female_lambda)^shape),
         Male_0     = exp(-(0/Male_lambda)^shape),
         Male_1     = exp(-(1/Male_lambda)^shape),
         Male_2     = exp(-(2/Male_lambda)^shape),
         Male_3     = exp(-(3/Male_lambda)^shape),
         Male_4     = exp(-(4/Male_lambda)^shape),
         Male_5     = exp(-(5/Male_lambda)^shape),
         Male_6     = exp(-(6/Male_lambda)^shape),
         Male_7     = exp(-(7/Male_lambda)^shape),
         Male_8     = exp(-(8/Male_lambda)^shape),
         Male_9     = exp(-(9/Male_lambda)^shape),
         Male_10    = exp(-(10/Male_lambda)^shape),
         Male_11    = exp(-(11/Male_lambda)^shape),
         Male_12    = exp(-(12/Male_lambda)^shape),
         Male_13    = exp(-(13/Male_lambda)^shape),
         Male_14    = exp(-(14/Male_lambda)^shape),
         Male_15    = exp(-(15/Male_lambda)^shape),
         Male_16    = exp(-(16/Male_lambda)^shape),
         Male_17    = exp(-(17/Male_lambda)^shape),
         Male_18    = exp(-(18/Male_lambda)^shape),
         Male_19    = exp(-(19/Male_lambda)^shape),
         Male_20    = exp(-(20/Male_lambda)^shape)) %>% 
    select(-c(Control_lambda, Female_lambda, Male_lambda, shape))


Weibull_extinction_estimates_long_b1 <-
  Weibull_extinction_estimates_b1 %>% 
  pivot_longer(cols = everything(), names_to = "Inheritance treatment", values_to = "Prop_families_surviving") %>% 
  separate(`Inheritance treatment`, into = c("Inheritance treatment", "Generation"), sep = "_")

Weibull_extinction_estimates_long <-
  Weibull_extinction_estimates %>% 
  pivot_longer(cols = everything(), names_to = "Inheritance treatment", values_to = "Prop_families_surviving") %>% 
  separate(`Inheritance treatment`, into = c("Inheritance treatment", "Generation"), sep = "_")

```

Lets plot the weibull survival figure and compare with the exponential plot

```{r, fig.height=7, fig.width=10}
# plot!
weibull_surv_plot_b1 <- 
  Weibull_extinction_estimates_long_b1 %>% 
  group_by(`Inheritance treatment`, Generation) %>% 
  tidybayes::median_qi(Prop_families_surviving, .width = 0.67) %>% 
  mutate(Generation = as.numeric(Generation)) %>% 
  arrange(Generation) %>% 
  # plot!
  ggplot(aes(x = Generation)) +
  #geom_hline(yintercept = .5, linetype = 3) +
  geom_ribbon(aes(ymin = .lower, ymax = .upper, fill = `Inheritance treatment`),
              alpha = 1/2) +
  geom_line(aes(y = Prop_families_surviving, color = `Inheritance treatment`), linetype =5, size = 0.8) +
  scale_fill_manual(values = met.brewer("Hiroshige", 3)) +
  scale_color_manual(values = met.brewer("Hiroshige", 3)) +
  scale_y_continuous("Proportion of surving families", breaks = c(0, 0.25, .5, 0.75, 1), limits = 0:1) +
  xlab("Generations of inbreeding") +
  theme_classic() + 
  theme(panel.background = element_rect(fill='transparent'), #transparent panel bg
        plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
        panel.grid.major = element_blank(), #remove major gridlines
        panel.grid.minor = element_blank(), #remove minor gridlines
        legend.background = element_rect(fill='transparent'), #transparent legend bg
        legend.box.background = element_rect(fill='transparent', colour = 'transparent'), #transparent legend panel
        text = element_text(size=20))

weibull_surv_plot <- 
  Weibull_extinction_estimates_long %>% 
  group_by(`Inheritance treatment`, Generation) %>% 
  tidybayes::median_qi(Prop_families_surviving, .width = 0.67) %>% 
  mutate(Generation = as.numeric(Generation)) %>% 
  arrange(Generation) %>% 
  # plot!
  ggplot(aes(x = Generation)) +
  #geom_hline(yintercept = .5, linetype = 3) +
  geom_ribbon(aes(ymin = .lower, ymax = .upper, fill = `Inheritance treatment`),
              alpha = 1/2) +
  geom_line(aes(y = Prop_families_surviving, color = `Inheritance treatment`), linetype =5, size = 0.8) +
  scale_fill_manual(values = met.brewer("Hiroshige", 3)) +
  scale_color_manual(values = met.brewer("Hiroshige", 3), guide = "none") +
  scale_y_continuous("Proportion of surving families", breaks = c(0, 0.25, .5, 0.75, 1), limits = 0:1) +
  xlab("Generations of inbreeding") +
  labs(fill = "Evolved autosomes") +
  theme_classic() + 
  theme(panel.background = element_rect(fill='transparent'), #transparent panel bg
        plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
        panel.grid.major = element_blank(), #remove major gridlines
        panel.grid.minor = element_blank(), #remove minor gridlines
        legend.background = element_rect(fill='transparent'), #transparent legend bg
        legend.box.background = element_rect(fill='transparent', colour = 'transparent'), #transparent legend panel
        legend.position = c(.85, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        text = element_text(size=24))



weibull_surv_plot_b_b1 <-
  Weibull_extinction_estimates_long_b1 %>% 
  ggplot(aes(x = as.numeric(Generation), y = Prop_families_surviving, colour = `Inheritance treatment`)) +
  #geom_ribbon()
  stat_pointinterval(.width = 0.67) +
  scale_color_manual(name = "Evolutionary history", values = met.brewer("Hiroshige", 3)) +
  scale_y_continuous("Proportion of surving families", breaks = c(0, 0.25, .5, 0.75, 1), limits = 0:1) +
  xlab("Generation of inbreeding") +
  #labs(title = "Weibull model") +
  theme_bw() + 
  theme(panel.grid.minor = element_blank())#,
        #text = element_text(size = 20))#,
        #legend.position = "none")

weibull_surv_plot_b <-
  Weibull_extinction_estimates_long %>% 
  ggplot(aes(x = as.numeric(Generation), y = Prop_families_surviving, colour = `Inheritance treatment`)) +
  #geom_ribbon()
  stat_pointinterval(.width = 0.67) +
  scale_color_manual(name = "Evolutionary history", values = met.brewer("Hiroshige", 3)) +
  scale_y_continuous("Proportion of surving families", breaks = c(0, 0.25, .5, 0.75, 1), limits = 0:1) +
  xlab("Generation of inbreeding") +
  #labs(title = "Weibull model") +
  theme_bw() + 
  theme(panel.grid.minor = element_blank())#,
        #text = element_text(size = 20))#,
        #legend.position = "none")

weibull_surv_plot + exponential_surv_plot 
```


We can also plot the mean generations until extinction for each evolution treatment.

```{r}

new_data <- tibble(
  Treatment = extinction_data$Treatment,
  Block = 1) %>% 
  distinct(Treatment, Block)

weibull_estimates_b1 <- 
  fitted(extinction_model_weibull_b1, newdata = new_data,
         re_formula = NA, summary = F) %>% 
  as_tibble() %>% 
  rename(Female = V1, Male = V2, Control = V3) 

mean_weibull_estimates_b1 <- 
  weibull_estimates_b1 %>% 
  pivot_longer(cols = 1:3, names_to = "Evolution_treatment", values_to = "generations")

# calculate contrasts

weibull_contrasts_b1 <-
  weibull_estimates_b1 %>% 
  mutate(`Female - Control` = Female - Control,
         `Male - Control` = Male - Control,
         `Male - Female` = Male - Female) %>% 
  select(-c(Male, Control, Female)) %>% 
  pivot_longer(cols = 1:3, names_to = "Contrast", values_to = "generation_diff")



# Now the whole dataset

weibull_estimates <- 
  fitted(extinction_model_weibull, newdata = new_data,
         re_formula = NA, summary = F) %>% 
  as_tibble() %>% 
  rename(Female = V1, Male = V2, Control = V3) 

mean_weibull_estimates <- 
  weibull_estimates %>% 
  pivot_longer(cols = 1:3, names_to = "Evolution_treatment", values_to = "generations")

# calculate contrasts

weibull_contrasts <-
  weibull_estimates %>% 
  mutate(`Female - Control` = Female - Control,
         `Male - Control` = Male - Control,
         `Male - Female` = Male - Female) %>% 
  select(-c(Male, Control, Female)) %>% 
  pivot_longer(cols = 1:3, names_to = "Contrast", values_to = "generation_diff")

  
```

Now plot. Note that this is the mean generations till extinction for each evolution treatment

```{r}
# plot the means

ext_w_p1_b1 <- 
  mean_weibull_estimates_b1 %>% 
  ggplot(aes(x = generations, y = Evolution_treatment)) +
  stat_halfeye(aes(fill = Evolution_treatment), .width = c(0.66, 0.95), alpha = 1,
               point_interval = "mean_qi", point_fill = "white",
               shape = 21, point_size = 3, stroke = 1.5,
               slab_colour = "black") + # width indicates the uncertainty intervals: here we have 66% and 95% intervals + # width indicates the uncertainty intervals: here we have 66% and 95% intervals+
  scale_fill_manual(values = met.brewer("Hiroshige", 5)) +
  ylab("Inheritance treatment") +
  xlab("Mean generations till extinction") +
  #coord_cartesian(ylim = c(1.5, 5.1)) +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor = element_blank())

ext_w_p1 <- 
  mean_weibull_estimates %>% 
  ggplot(aes(x = generations, y = Evolution_treatment)) +
  stat_halfeye(aes(fill = Evolution_treatment), .width = c(0.66, 0.95), alpha = 1,
               point_interval = "mean_qi", point_fill = "white",
               shape = 21, point_size = 3, stroke = 1.5,
               slab_colour = "black") + # width indicates the uncertainty intervals: here we have 66% and 95% intervals + # width indicates the uncertainty intervals: here we have 66% and 95% intervals+
  scale_fill_manual(values = met.brewer("Hiroshige", 5)) +
  ylab("Inheritance treatment") +
  xlab("Mean generations till extinction") +
  scale_x_continuous(breaks = 4:10) +
  #coord_cartesian(ylim = c(1.5, 5.1)) +
  theme_classic() + 
  theme(panel.background = element_rect(fill='transparent'), #transparent panel bg
        plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
        #panel.grid.major = element_blank(), #remove major gridlines
        #panel.grid.minor = element_blank(), #remove minor gridlines
        legend.position = "none", #transparent legend panel
        text = element_text(size=20))

# plot the contrasts

ext_w_p2_b1 <- 
  weibull_contrasts_b1 %>% 
  ggplot(aes(x = generation_diff, y = Contrast)) +
  stat_halfeye(aes(fill = Contrast), .width = c(0.66, 0.95), alpha = 1,
               point_interval = "mean_qi", point_fill = "white",
               shape = 21, point_size = 3, stroke = 1.5,
               slab_colour = "black") + 
  geom_vline(xintercept = 0, linetype = 2, colour = "black") +
  scale_fill_manual(values = met.brewer("Hiroshige", 5)) +
  ylab("Treatment contrast") +
  xlab("Difference in mean generations till extinction") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor = element_blank())#,
#text = element_text(size = 20))

ext_w_p2 <- 
  weibull_contrasts %>% 
  ggplot(aes(x = generation_diff, y = Contrast)) +
  stat_halfeye(aes(fill = met.brewer("Hiroshige")[1]), .width = c(0.66, 0.95), alpha = 1,
               point_interval = "mean_qi", point_fill = "white",
               shape = 21, point_size = 3, stroke = 1.5,
               slab_colour = "black") + 
  geom_vline(xintercept = 0, linetype = 2, colour = "black", size = 1) +
  ylab("Treatment contrast") +
  xlab("Difference in mean generations till extinction") +
  scale_x_continuous(breaks = -2:4) +
  theme_classic() + 
  theme(panel.background = element_rect(fill='transparent'), #transparent panel bg
        plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
        #panel.grid.major = element_blank(), #remove major gridlines
        #panel.grid.minor = element_blank(), #remove minor gridlines
        legend.position = "none", #transparent legend panel
        text = element_text(size=20))
#text = element_text(size = 20))

(weibull_surv_plot + ext_w_p1 + ext_w_p2) &
    theme(panel.background = element_rect(fill='transparent'), #transparent panel bg
          plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
          panel.grid.major = element_blank(), #remove major gridlines
          panel.grid.minor = element_blank(), #remove minor gridlines
          legend.background = element_rect(fill='transparent'), #transparent legend bg
          legend.box.background = element_rect(fill='transparent', colour = 'transparent')) #transparent legend panel
  
  
```

Another way to explore this model is to ask: About how many generations would it take for half of the populations of a given evolutionary history to go extinct? We can do this with help from the `qweibull()` function. For example:

```{r}

```


We can also plot the difference in proportion of populations extant at each generation. The figure below only shows the difference between families inheriting maternal and paternally inherited autosomes.

```{r}
Difference_with_males <-
  Weibull_extinction_estimates %>% 
  mutate(G1_diff.c = Male_1 - Control_1,
         G1_diff.f = Male_1 - Female_1,
         G2_diff.c = Male_2 - Control_2,
         G2_diff.f = Male_2 - Female_2,
         G3_diff.c = Male_3 - Control_3,
         G3_diff.f = Male_3 - Female_3,
         G4_diff.c = Male_4 - Control_4,
         G4_diff.f = Male_4 - Female_4,
         G5_diff.c = Male_5 - Control_5,
         G5_diff.f = Male_5 - Female_5,
         G6_diff.c = Male_6 - Control_6,
         G6_diff.f = Male_6 - Female_6,
         G7_diff.c = Male_7 - Control_7,
         G7_diff.f = Male_7 - Female_7,
         G8_diff.c = Male_8 - Control_8,
         G8_diff.f = Male_8 - Female_8,
         G9_diff.c = Male_9 - Control_9,
         G9_diff.f = Male_9 - Female_9,
         G10_diff.c = Male_10 - Control_10,
         G10_diff.f = Male_10 - Female_10,
         G11_diff.c = Male_11 - Control_11,
         G11_diff.f = Male_11 - Female_11,
         G12_diff.c = Male_12 - Control_12,
         G12_diff.f = Male_12 - Female_12,
         G13_diff.c = Male_13 - Control_13,
         G13_diff.f = Male_13 - Female_13,
         G14_diff.c = Male_14 - Control_14,
         G14_diff.f = Male_14 - Female_14,
         G15_diff.c = Male_15 - Control_15,
         G15_diff.f = Male_15 - Female_15,
         G16_diff.c = Male_16 - Control_16,
         G16_diff.f = Male_16 - Female_16,
         G17_diff.c = Male_17 - Control_17,
         G17_diff.f = Male_17 - Female_17,
         G18_diff.c = Male_18 - Control_18,
         G18_diff.f = Male_18 - Female_18,
         G19_diff.c = Male_19 - Control_19,
         G19_diff.f = Male_19 - Female_19,
         G20_diff.c = Male_20 - Control_20,
         G20_diff.f = Male_20 - Female_20) %>% 
  select(starts_with("G")) %>% 
  pivot_longer(cols = everything(), names_to = "Difference contrast", values_to = "survival_diff") %>% 
  separate(`Difference contrast`, into = c("Generation", "Difference contrast"), sep = "_") %>% 
  mutate(Generation = as.numeric(str_remove(Generation, "G")))


Difference_plot <-
  Difference_with_males %>% 
  filter(`Difference contrast` == "diff.f") %>% 
  ggplot(aes(x = survival_diff , y = as.factor(Generation), fill = `Difference contrast`)) +
  stat_halfeye(height = 4, alpha = 0.8) +
  scale_fill_manual(values = met.brewer("Hiroshige")[3]) +
  geom_vline(xintercept = 0, linetype = 2, colour = "black") +
  labs(x = "Diff. prop. families surviving that carry\n male-adapted autsomes versus female-adapted autosomes",
       y = "Generation of inbreeding") +
  theme_classic() + 
  theme(panel.background = element_rect(fill='transparent'), #transparent panel bg
        plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
        panel.grid.major = element_blank(), #remove major gridlines
        panel.grid.minor = element_blank(), #remove minor gridlines
        legend.position="none", #transparent legend panel
        text = element_text(size=20))

```
